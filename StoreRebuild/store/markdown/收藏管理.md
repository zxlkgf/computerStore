# 7 收藏管理

## 7.1 创建实体类

```sql
CREATE TABLE t_favorites(
fid INT PRIMARY KEY AUTO_INCREMENT COMMENT '收藏商品在数据表的id',
uid INT COMMENT '归属的用户id',
pid INT COMMENT '归属的商品id',
image VARCHAR(255) COMMENT '商品图片保存地址',
price BIGINT COMMENT '商品的价格',
title VARCHAR(255) COMMENT '商品的标题',
sell_point VARCHAR(255) COMMENT '商品的卖点',
status INT COMMENT '商品的收藏状态'
); 
```

## 7.2 创建实体类

```java
/**
 * @author zxl
 * @description 收藏实体类
 * @date 2022/11/6
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Favorite extends BaseEntity {
    private Integer fid;
    private Integer uid;
    private Integer pid;
    private String image;
    private Long price;
    private String title;
    private String sellPoint;
    private Integer status;
}

```

---

## 7.3 加入收藏

### 7.3.1 后端-持久层

---

#### 1.编写sql

```sql
//插入收藏
insert into t_favorite(除了fid)values(值)
```

---

#### 2.编写Mapper接口

```java
    /**
     * 插入收藏
     * @param favorite 收藏数据
     * @return
     */
    Integer addFavorite(Favorite favorite);
```

---

#### 3.编写映射文件

```xml
<mapper namespace="com.zxl.store.mappers.FavoriteMapper">
<!--    Integer addFavorite(Favorite favorite);-->
    <insert id="addFavorite" parameterType="com.zxl.store.entity.Favorite" useGeneratedKeys="true" keyProperty="fid">
        INSERT INTO t_favorite(
            uid,
            pid,
            image,
            price,
            title,
            sell_point,
            status
        )
        VALUES (
            #{uid},
            #{pid},
            #{image},
            #{price},
            #{title},
            #{sellPoint},
            #{status}
        )
    </insert>
</mapper>
```

---

#### 4.单元测试

---

### 7.3.2 后端-业务层

#### 1.编写异常

----

#### 2.编写业务层抽象方法

```java
/**
 * @author zxl
 * @description 收藏业务层的接口
 * @date 2022/11/6
 */
public interface IFavoriteService  {

    /**
     * 插入收藏
     * @param uid
     * @param pid
     */
    Integer addFavorite(Integer uid,Integer pid);
}

```

#### 3.编写实现逻辑

```java

/**
 * @author zxl
 * @description 收藏接口的业务层实现类
 * @date 2022/11/6
 */
@Service
public class IFavoriteServiceImpl implements IFavoriteService {
    @Autowired(required = false)
    private FavoriteMapper favoriteMapper;
    @Autowired
    private IProductService productService;

    @Override
    public Integer addFavorite(Integer uid, Integer pid) {
        Favorite favorite = new Favorite();
        //根据pid查询信息
        Product p = productService.findProductById(pid);
        //加入数据
        favorite.setUid(uid);
        favorite.setPid(pid);
        favorite.setImage(p.getImage());
        favorite.setPrice(p.getPrice());
        favorite.setTitle(p.getTitle());
        favorite.setSellPoint(p.getSellPoint());
        favorite.setStatus(p.getStatus());
        //执行插入
        Integer res = favoriteMapper.addFavorite(favorite);
        //判断插入结果
        if(res!=1)throw new InsertException("插入收藏时出现未知错误");
        return favorite.getFid();
    }
}

```

---

#### 4.单元测试

---

### 7.3.3 后端-控制层

#### 1.处理异常

----

#### 2.设计请求

请求路径：/favorite/addFavorite

请求类型：HttpSession session,Integer pid

请求方式：post

响应类型：JsonResult< Integer>

---

#### 3.处理请求编写控制类

```java
/**
 * @author zxl
 * @description 添加收藏的控制类
 * @date 2022/11/6
 */
@RestController
@RequestMapping("/favorite")
public class FavoriteController extends BaseController {
    @Autowired
    private IFavoriteService favoriteService;

    @RequestMapping(value = "/addFavorite",method = RequestMethod.POST)
    public JsonResult<Integer> addFavorite(Integer pid, HttpSession session){
        //uid
        Integer uid = getUserIdFromSession(session);
        //执行插入
        Integer fid = favoriteService.addFavorite(uid, pid);
        return new JsonResult<>(OK,fid);
    }
}
```

---

#### 4.前端页面

```javascript
				//绑定收藏事件
				$("#btn-add-to-collect").click(function () {
					if (confirm("确定要将此商品加入收藏吗？")) {
						$.ajax({
							url: "/favorite/addFavorite",
							type: "post",
							data: {"pid": pid},
							dataType: "json",
							success: function (res) {
								if (res.state == 200) {
									alert("收藏成功！");
								} else {
									alert(res.message);
								}
							},
							error: function (err) {
								alert("服务器出现错误，加入购物车失败！")
							}
						})
					}
				});
```

---

## 7.4 显示收藏

### 7.4.1 后端-持久层

---

#### 1.编写sql

```sql

```

---

#### 2.编写Mapper接口抽象方法

```java

```

---

#### 3.编写映射文件

```xml

```

---

#### 4.单元测试

---

### 7.4.2 后端-业务层

---

#### 1.编写异常

---

#### 2.编写业务层抽象方法

```java

```

---

#### 3.编写实现逻辑

```java

```

---

#### 4.单元测试

---

### 7.4.3 后端-控制层

----

#### 1.处理异常

---

#### 2.设计请求

---

#### 3.处理请求 编写控制方法

```java

```

---

#### 4.前端页面

```javascript

```

---

## 7.5 删除收藏

---

### 7.5.1 后端-持久层

---

#### 1.编写sql

```sql

```

---

#### 2.编写Mapper抽象方法

```java

```

---

#### 3.编写Mapper映射

```xml

```

---

#### 4.单元测试

---

### 7.5.2 后端-业务层

---

#### 1.编写异常

---

#### 2.编写业务层抽象方法

---

#### 3.编写实现逻辑

---

#### 4.单元测试

---

### 7.5.3 后端-控制层

---

#### 1.处理异常

---

#### 2.设计请求

---

#### 3.处理请求 编写控制方法

---

#### 4.前端页面

---
